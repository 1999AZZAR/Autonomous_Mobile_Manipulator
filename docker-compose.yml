services:
  # The ROS 2 and Gazebo Simulation Service
  ros2-sim:
    build:
      context: ./ros2_ws  # Tells Docker Compose to use the Dockerfile in the ./ros2_ws folder
    container_name: ros2_sim_container
    # Launch Gazebo simulation with robot
    command: >
      bash -c "
      source /opt/ros/iron/setup.bash &&
      cd /root/ros2_ws &&
      echo 'Building robot packages...' &&
      colcon build --packages-select my_robot_description my_robot_bringup &&
      source install/setup.bash &&
      echo 'Packages built successfully' &&
      echo 'Starting Gazebo simulation...' &&
      ros2 launch my_robot_bringup gazebo_simple.launch.py
      "
    # Share the source code folder so you can edit code on your PC and it updates inside the container
    volumes:
      - ./ros2_ws/src:/root/ros2_ws/src
    # Network settings to allow Gazebo GUI to display on your PC (Wayland mode)
    environment:
      - DISPLAY=${DISPLAY}
      - WAYLAND_DISPLAY=${WAYLAND_DISPLAY}
      - XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR}
      - QT_QPA_PLATFORM=wayland
      - QT_X11_NO_MITSHM=1
      - GAZEBO_MODEL_PATH=/root/ros2_ws/src/my_robot_description/models
      - PYTHONPATH=/root/ros2_ws/install/my_robot_automation/lib/python3.10/site-packages:$PYTHONPATH
    # Allows the container to access your host machine's graphics hardware
    privileged: true
    network_mode: "host" # Simplifies GUI forwarding for Gazebo/RViz
    ports:
      - "5678:5678" # REST API server port
      - "8765:8765" # WebSocket server port
      - "5000:5000" # Web Robot Interface port

  # The n8n Workflow Automation Service
  n8n:
    image: docker.io/n8nio/n8n:1.115.2 # Latest stable version
    container_name: n8n_container
    restart: always
    network_mode: "host" # Use host networking to access robot API
    environment:
      - GENERIC_TIMEZONE=Asia/Jakarta # Set your local timezone
    volumes:
      - ./n8n_data:/home/node/.n8n # Persists your n8n workflows and data on your PC
      - ./n8n_data/custom_nodes:/home/node/.n8n/custom_nodes # Mount custom nodes
    depends_on:
      - ros2-sim

volumes:
  n8n_data:
