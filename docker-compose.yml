services:
  # The ROS 2 and Gazebo Simulation Service
  ros2-sim:
    build:
      context: ./ros2_ws  # Tells Docker Compose to use the Dockerfile in the ./ros2_ws folder
    container_name: ros2_sim_container
    # Launch ROS2 automation services only (no Gazebo for faster testing)
    command: >
      bash -c "
      source /opt/ros/jazzy/setup.bash &&
      cd /root/ros2_ws &&
      echo 'Installing Python dependencies...' &&
      pip3 install --break-system-packages requests smbus2 mpu6050-raspberrypi spidev flask 2>/dev/null || true &&
      echo 'Building robot packages...' &&
      timeout 300 colcon build --packages-select my_robot_description my_robot_bringup my_robot_automation --event-handlers console_direct+ &&
      if [ $? -eq 0 ]; then
        source install/setup.bash &&
        echo 'Packages built successfully' &&
        echo 'Starting ROS2 REST API server...' &&
        python3 /root/ros2_ws/src/my_robot_automation/scripts/rest_api_server.py &
        sleep 3 &&
        echo 'Starting Web Interface...' &&
        python3 /root/ros2_ws/src/my_robot_automation/scripts/web_robot_interface.py &
        sleep 2 &&
        echo 'Services started. Web UI: http://localhost:8000, API: http://localhost:5000' &&
        tail -f /dev/null
      else
        echo 'Build failed - starting with existing packages' &&
        source install/setup.bash &&
        python3 /root/ros2_ws/src/my_robot_automation/scripts/rest_api_server.py &
        sleep 3 &&
        python3 /root/ros2_ws/src/my_robot_automation/scripts/web_robot_interface.py &
        sleep 2 &&
        echo 'Services started. Web UI: http://localhost:8000, API: http://localhost:5000' &&
        tail -f /dev/null
      fi
      "
    # Share the source code folder so you can edit code on your PC and it updates inside the container
    volumes:
      - ./ros2_ws/src:/root/ros2_ws/src
    # Network settings to allow Gazebo GUI to display on your PC
    environment:
      - DISPLAY=${DISPLAY:-:0}
      - WAYLAND_DISPLAY=${WAYLAND_DISPLAY}
      - XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR}
      - QT_QPA_PLATFORM=xcb
      - QT_X11_NO_MITSHM=1
      - LIBGL_ALWAYS_INDIRECT=1
      - GAZEBO_MODEL_PATH=/root/ros2_ws/src/my_robot_description/models
      - PYTHONPATH=/root/ros2_ws/install/my_robot_automation/lib/python3.10/site-packages:$PYTHONPATH
    # Allows the container to access your host machine's graphics hardware
    privileged: true
    network_mode: "host" # Simplifies GUI forwarding for Gazebo/RViz
    ports:
      - "5678:5678" # n8n workflow interface
      - "5000:5000" # Advanced REST API server port
      - "8000:8000" # Professional web interface port
      - "8765:8765" # WebSocket server port

  # The n8n Workflow Automation Service
  n8n:
    image: docker.io/n8nio/n8n:latest # Latest stable version
    container_name: n8n_container
    restart: always
    network_mode: "host" # Use host networking to access robot API
    ports:
      - "5678:5678" # n8n web interface
    environment:
      - GENERIC_TIMEZONE=Asia/Jakarta # Set your local timezone
      - N8N_BASIC_AUTH_ACTIVE=false # Disable basic auth for API access
      - N8N_BASIC_AUTH_USER= # Empty user
      - N8N_BASIC_AUTH_PASSWORD= # Empty password
      - N8N_JWT_SECRET=super-secret-jwt-key-for-development # JWT secret for API
      - N8N_ENCRYPTION_KEY=super-secret-encryption-key # Encryption key
      - N8N_SKIP_WEBHOOK_DEREGISTRATION_FROM_LOADER=true
      - N8N_PUBLIC_API_DISABLED=false
      - N8N_PUBLIC_API_SWAGGERUI_DISABLED=false
      - N8N_SECURE_COOKIE=false # Disable secure cookie for HTTP access
    volumes:
      - ./n8n_data:/home/node/.n8n # Persists your n8n workflows and data on your PC
      - ./n8n_data/custom_nodes:/home/node/.n8n/custom_nodes # Mount custom nodes
    depends_on:
      - ros2-sim

volumes:
  n8n_data:
