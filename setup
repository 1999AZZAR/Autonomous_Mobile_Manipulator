#!/bin/bash

#################################################################
# LKS Robot Project - Unified Setup Script
# Handles complete system setup for both Raspberry Pi and PC
#################################################################

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROS2_WS="$SCRIPT_DIR/ros2_ws"

# Configuration
PLATFORM=""
SKIP_REBOOT=false

#################################################################
# Print Functions
#################################################################

print_header() {
    echo -e "${CYAN}=================================================================${NC}"
    echo -e "${WHITE}  $1${NC}"
    echo -e "${CYAN}=================================================================${NC}"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

#################################################################
# Common Functions
#################################################################

check_root() {
    if [ "$EUID" -eq 0 ]; then 
        print_error "Do not run this script as root. Run as normal user."
        exit 1
    fi
}

detect_platform() {
    if grep -q "Raspberry Pi" /proc/device-tree/model 2>/dev/null; then
        echo "rpi"
    else
        echo "pc"
    fi
}

#################################################################
# Prerequisites Check
#################################################################

check_prerequisites() {
    print_header "Prerequisites Check"
    
    local all_ok=true
    
    # Check Docker
    if command -v docker &> /dev/null; then
        print_success "Docker installed: $(docker --version | cut -d' ' -f3)"
        if docker ps &> /dev/null; then
            print_success "Docker daemon running"
        else
            print_warning "Docker daemon not running - will attempt to start"
            sudo systemctl start docker || all_ok=false
        fi
    else
        print_warning "Docker not installed - will install"
        all_ok=false
    fi
    
    # Check Docker Compose
    if docker compose version &> /dev/null || command -v docker-compose &> /dev/null; then
        print_success "Docker Compose available"
    else
        print_warning "Docker Compose not available - will install"
        all_ok=false
    fi
    
    # Check Python
    if command -v python3 &> /dev/null; then
        print_success "Python3 installed: $(python3 --version)"
    else
        print_error "Python3 not found"
        all_ok=false
    fi
    
    echo ""
    return 0  # Continue even if some checks fail
}

#################################################################
# Common Setup Functions
#################################################################

install_docker() {
    print_info "Installing Docker..."
    
    # Add Docker GPG key
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    
    # Add Docker repository
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    
    # Install Docker
    sudo apt update
    sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
    
    # Start and enable Docker
    sudo systemctl start docker
    sudo systemctl enable docker
    
    # Add user to docker group
    sudo usermod -aG docker $USER
    
    print_success "Docker installed"
}

configure_docker() {
    print_info "Configuring Docker..."
    
    sudo tee /etc/docker/daemon.json > /dev/null <<EOF
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  },
  "storage-driver": "overlay2"
}
EOF
    
    sudo systemctl restart docker
    print_success "Docker configured"
}

install_common_dependencies() {
    print_info "Installing common dependencies..."
    
    sudo apt update
    sudo apt install -y \
        curl wget git vim htop net-tools \
        python3-pip python3-dev build-essential \
        ca-certificates gnupg lsb-release
    
    print_success "Common dependencies installed"
}

build_ros2_workspace() {
    print_header "Building ROS2 Workspace"
    
    if [ ! -d "$ROS2_WS" ]; then
        print_error "ROS2 workspace not found: $ROS2_WS"
        return 1
    fi
    
    cd "$ROS2_WS"
    
    # Check for ROS2 installation
    if [ -f "/opt/ros/humble/setup.bash" ]; then
        print_info "Using ROS2 Humble"
        source /opt/ros/humble/setup.bash
    elif [ -f "/opt/ros/iron/setup.bash" ]; then
        print_info "Using ROS2 Iron"
        source /opt/ros/iron/setup.bash
    else
        print_warning "ROS2 not found - will build in Docker"
    fi
    
    # Check colcon
    if ! command -v colcon &> /dev/null; then
        print_info "Installing colcon..."
        sudo apt install -y python3-colcon-common-extensions
    fi
    
    # Install Python dependencies
    print_info "Installing Python dependencies..."
    pip3 install flask requests websockets || true
    
    # Build workspace
    print_info "Building workspace (this may take a few minutes)..."
    colcon build
    
    if [ $? -eq 0 ]; then
        print_success "ROS2 workspace built successfully"
    else
        print_error "Workspace build failed"
        return 1
    fi
    
    cd "$SCRIPT_DIR"
}

create_monitoring_scripts() {
    print_info "Creating monitoring scripts..."
    
    mkdir -p ~/ros2_logs
    
    # Copy log maintenance script
    if [ -f "$SCRIPT_DIR/ros2_log_maintenance.sh" ]; then
        cp "$SCRIPT_DIR/ros2_log_maintenance.sh" ~/ros2_log_maintenance.sh
        chmod +x ~/ros2_log_maintenance.sh
        print_success "Log maintenance script installed"
    fi
    
    print_success "Monitoring configured"
}

#################################################################
# Raspberry Pi Specific Setup
#################################################################

setup_raspberry_pi() {
    print_header "Raspberry Pi Setup"
    
    # System update
    print_info "Updating system packages..."
    sudo apt update && sudo apt upgrade -y
    
    # Configure hostname and timezone
    print_info "Configuring system..."
    sudo hostnamectl set-hostname lks-robot
    sudo timedatectl set-timezone Asia/Jakarta
    
    # Enable hardware interfaces
    print_info "Enabling hardware interfaces..."
    local config_file="/boot/firmware/config.txt"
    
    if [ -f "$config_file" ]; then
        # Enable I2C
        if ! grep -q "^dtparam=i2c_arm=on" "$config_file"; then
            echo "dtparam=i2c_arm=on" | sudo tee -a "$config_file"
        fi
        
        # Enable SPI
        if ! grep -q "^dtparam=spi=on" "$config_file"; then
            echo "dtparam=spi=on" | sudo tee -a "$config_file"
        fi
        
        # Enable UART
        if ! grep -q "^enable_uart=1" "$config_file"; then
            echo "enable_uart=1" | sudo tee -a "$config_file"
        fi
        
        print_success "Hardware interfaces configured"
    else
        print_warning "Config file not found - using raspi-config"
        sudo raspi-config nonint do_i2c 0
        sudo raspi-config nonint do_spi 0
        sudo raspi-config nonint do_serial 0
    fi
    
    # Install Raspberry Pi dependencies
    print_info "Installing Raspberry Pi dependencies..."
    sudo apt install -y \
        i2c-tools python3-smbus \
        libgpiod-dev gpiod \
        python3-pigpio python3-rpi.gpio python3-lgpio python3-gpiozero \
        python3-numpy
    
    # Install MPU6050 library
    pip3 install mpu6050-raspberrypi --break-system-packages || true
    
    # Add user to hardware groups
    print_info "Configuring hardware permissions..."
    sudo usermod -aG dialout,i2c,gpio,video $USER
    
    # Configure GPIO permissions
    sudo tee /usr/local/bin/setup-gpio-permissions > /dev/null <<'EOF'
#!/bin/bash
sudo chown root:gpio /dev/gpiomem 2>/dev/null || true
sudo chmod g+rw /dev/gpiomem 2>/dev/null || true
sudo chown root:i2c /dev/i2c-1 2>/dev/null || true
sudo chmod g+rw /dev/i2c-1 2>/dev/null || true
EOF
    sudo chmod +x /usr/local/bin/setup-gpio-permissions
    
    # Configure firewall
    print_info "Configuring firewall..."
    sudo apt install -y ufw
    sudo ufw --force enable
    sudo ufw default deny incoming
    sudo ufw default allow outgoing
    sudo ufw allow ssh
    sudo ufw allow 5000  # Robot API
    sudo ufw allow 5678  # n8n
    sudo ufw allow 8000  # Web interface
    sudo ufw allow 8765  # WebSocket
    
    # Performance optimizations
    print_info "Applying performance optimizations..."
    
    # Configure swap
    if [ ! -f /swapfile ]; then
        sudo fallocate -l 2G /swapfile 2>/dev/null || sudo dd if=/dev/zero of=/swapfile bs=1M count=2048
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        
        if ! grep -q "/swapfile" /etc/fstab; then
            echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
        fi
    fi
    
    print_success "Raspberry Pi setup complete"
}

#################################################################
# PC Specific Setup
#################################################################

setup_pc() {
    print_header "PC/Development Setup"
    
    # Install development tools
    print_info "Installing development tools..."
    sudo apt install -y \
        code vim-gtk3 \
        terminator tmux \
        python3-venv \
        colcon python3-colcon-common-extensions
    
    # Install ROS2 if not present
    if [ ! -f "/opt/ros/humble/setup.bash" ] && [ ! -f "/opt/ros/iron/setup.bash" ]; then
        print_warning "ROS2 not detected - consider installing ROS2 Humble"
        print_info "Visit: https://docs.ros.org/en/humble/Installation.html"
    fi
    
    print_success "PC setup complete"
}

#################################################################
# Post-Setup Tasks
#################################################################

post_setup_tasks() {
    print_header "Post-Setup Tasks"
    
    # Create monitoring scripts
    create_monitoring_scripts
    
    # Build workspace
    build_ros2_workspace || print_warning "Workspace build failed - you may build it later"
    
    # Set up log maintenance cron (optional)
    if command -v crontab &> /dev/null; then
        print_info "Setting up log maintenance..."
        (crontab -l 2>/dev/null | grep -v ros2_log_maintenance; echo "0 2 * * * ~/ros2_log_maintenance.sh") | crontab - || true
    fi
    
    print_success "Post-setup tasks complete"
}

verify_setup() {
    print_header "Setup Verification"
    
    local errors=0
    
    # Check Docker
    if docker ps &> /dev/null; then
        print_success "Docker working"
    else
        print_error "Docker not working"
        ((errors++))
    fi
    
    # Check ROS2 workspace
    if [ -f "$ROS2_WS/install/setup.bash" ]; then
        print_success "ROS2 workspace built"
    else
        print_warning "ROS2 workspace not built"
    fi
    
    # Check Python dependencies
    if python3 -c "import flask, requests" 2>/dev/null; then
        print_success "Python dependencies OK"
    else
        print_warning "Some Python dependencies missing"
    fi
    
    # Platform-specific checks
    if [ "$PLATFORM" = "rpi" ]; then
        # Check I2C
        if groups | grep -q i2c; then
            print_success "I2C group membership OK"
        else
            print_warning "User not in i2c group (logout required)"
        fi
        
        # Check GPIO
        if groups | grep -q gpio; then
            print_success "GPIO group membership OK"
        else
            print_warning "User not in gpio group (logout required)"
        fi
    fi
    
    echo ""
    if [ $errors -eq 0 ]; then
        print_success "Setup verification passed!"
    else
        print_warning "Setup completed with $errors errors"
    fi
}

#################################################################
# Main Setup Flow
#################################################################

show_usage() {
    cat << EOF
LKS Robot Project - Setup Script

USAGE:
    ./setup [OPTIONS]

OPTIONS:
    --rpi               Setup for Raspberry Pi (hardware mode)
    --pc                Setup for PC/Development
    --skip-reboot       Skip reboot prompt (for automation)
    -h, --help          Show this help message

EXAMPLES:
    ./setup --rpi       # Setup on Raspberry Pi
    ./setup --pc        # Setup on development PC

DESCRIPTION:
    This script performs complete system setup including:
    - Docker installation and configuration
    - System dependencies
    - ROS2 workspace building
    - Hardware interface configuration (RPi)
    - Monitoring scripts setup
    - Permission configuration

AFTER SETUP:
    Use './start' script to run the system:
    - ./start --hw      # Hardware mode (Raspberry Pi)
    - ./start --sim     # Simulation mode
    - ./start --test    # Test mode

EOF
}

main() {
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --rpi)
                PLATFORM="rpi"
                shift
                ;;
            --pc)
                PLATFORM="pc"
                shift
                ;;
            --skip-reboot)
                SKIP_REBOOT=true
                shift
                ;;
            -h|--help)
                show_usage
                exit 0
                ;;
            *)
                print_error "Unknown option: $1"
                show_usage
                exit 1
                ;;
        esac
    done
    
    # Check if platform specified
    if [ -z "$PLATFORM" ]; then
        # Try to auto-detect
        DETECTED=$(detect_platform)
        print_warning "No platform specified, detected: $DETECTED"
        read -p "Use detected platform? [Y/n]: " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Nn]$ ]]; then
            show_usage
            exit 1
        fi
        PLATFORM=$DETECTED
    fi
    
    # Run setup
    check_root
    print_header "LKS Robot Setup - Platform: ${PLATFORM^^}"
    
    check_prerequisites
    install_common_dependencies
    
    # Install Docker if needed
    if ! command -v docker &> /dev/null; then
        install_docker
    fi
    
    configure_docker
    
    # Platform-specific setup
    if [ "$PLATFORM" = "rpi" ]; then
        setup_raspberry_pi
    else
        setup_pc
    fi
    
    # Common post-setup
    post_setup_tasks
    verify_setup
    
    # Final message
    print_header "Setup Complete!"
    echo ""
    print_success "System setup finished successfully"
    echo ""
    print_info "Next steps:"
    echo "  1. Restart your session: logout/login or reboot"
    echo "  2. Start the robot: ./start --hw  (or --sim for simulation)"
    echo "  3. Test the system: ./start --test"
    echo ""
    
    if [ "$PLATFORM" = "rpi" ] && [ "$SKIP_REBOOT" = false ]; then
        read -p "Reboot now? [Y/n]: " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            print_info "Rebooting..."
            sudo reboot
        fi
    fi
}

main "$@"

