#!/bin/bash

#################################################################
# LKS Robot Project - Unified Start Script
# Handles running the system in hardware, simulation, or test mode
#################################################################

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m'

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROS2_WS="$SCRIPT_DIR/ros2_ws"

# Configuration
MODE=""
CONTAINER_NAME=""
COMPOSE_FILE="docker-compose.yml"
PROJECT_NAME="lks_robot"
BUILD_FLAG=""
DETACH=true
MINIMAL_MODE=false

#################################################################
# Print Functions
#################################################################

print_header() {
    echo -e "${CYAN}=================================================================${NC}"
    echo -e "${WHITE}  $1${NC}"
    echo -e "${CYAN}=================================================================${NC}"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

#################################################################
# Prerequisites Check
#################################################################

check_prerequisites() {
    local all_ok=true
    
    # Check Docker
    if ! command -v docker &> /dev/null; then
        print_error "Docker not installed. Run: ./setup --pc or ./setup --rpi"
        return 1
    fi
    
    if ! docker ps &> /dev/null; then
        print_error "Docker daemon not running. Start with: sudo systemctl start docker"
        return 1
    fi
    
    # Check Docker Compose
    if ! docker compose version &> /dev/null && ! command -v docker-compose &> /dev/null; then
        print_error "Docker Compose not available"
        return 1
    fi
    
    return 0
}

#################################################################
# Container Management
#################################################################

get_container_status() {
    if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
        if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
            echo "running"
        else
            echo "stopped"
        fi
    else
        echo "not_found"
    fi
}

start_containers() {
    print_header "Starting LKS Robot - Mode: ${MODE^^}"
    
    local status=$(get_container_status)
    if [ "$status" = "running" ]; then
        print_warning "Container already running"
        print_info "Use './start --restart' to restart or './start --stop' to stop"
        return 0
    fi
    
    # Determine compose file and settings based on mode
    case "$MODE" in
        hw|hardware)
            if [ "$MINIMAL_MODE" = true ]; then
                print_info "Starting in HARDWARE mode (minimal - Web UI + ROS2 only)"
                COMPOSE_FILE="docker-compose.minimal.yml"
                export ROBOT_MODE="hardware"
                CONTAINER_NAME="ros2_minimal_hw_container"
            else
                print_info "Starting in HARDWARE mode (real sensors + n8n)"
                COMPOSE_FILE="docker-compose.prod.yml"
                export ROBOT_MODE="hardware"
                CONTAINER_NAME="ros2_hw_container"
            fi
            ;;
        sim|simulation)
            if [ "$MINIMAL_MODE" = true ]; then
                print_info "Starting in SIMULATION mode (minimal - Web UI + ROS2 only)"
                COMPOSE_FILE="docker-compose.minimal.yml"
                export ROBOT_MODE="simulation"
                CONTAINER_NAME="ros2_minimal_sim_container"
            else
                print_info "Starting in SIMULATION mode (simulated sensors + n8n)"
                COMPOSE_FILE="docker-compose.dev.yml"
                export ROBOT_MODE="simulation"
                CONTAINER_NAME="ros2_sim_container"
            fi
            ;;
        *)
            print_error "Invalid mode: $MODE"
            return 1
            ;;
    esac
    
    # Check if compose file exists
    if [ ! -f "$COMPOSE_FILE" ]; then
        print_error "Compose file not found: $COMPOSE_FILE"
        return 1
    fi
    
    # Start containers
    print_info "Starting Docker containers..."
    local cmd_flags="$BUILD_FLAG"
    
    if [ "$DETACH" = true ]; then
        cmd_flags="$cmd_flags -d"
    fi
    
    if docker compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" up $cmd_flags; then
        print_success "Containers started"
    else
        print_error "Failed to start containers"
        return 1
    fi
    
    # Wait for services
    if [ "$DETACH" = true ]; then
        print_info "Waiting for services to initialize..."
        sleep 5
        
        # Check services
        check_service_health
    fi
    
    # Show access info
    show_access_info
}

stop_containers() {
    print_header "Stopping LKS Robot"
    
    # Try all possible compose files
    for compose in docker-compose.yml docker-compose.dev.yml docker-compose.prod.yml; do
        if [ -f "$compose" ]; then
            docker compose -f "$compose" -p "$PROJECT_NAME" down 2>/dev/null || true
        fi
    done
    
    print_success "Containers stopped"
}

restart_containers() {
    print_header "Restarting LKS Robot"
    stop_containers
    sleep 2
    start_containers
}

#################################################################
# Status and Health Checks
#################################################################

show_status() {
    print_header "System Status"
    
    echo -e "${BLUE}Containers:${NC}"
    docker ps -a --filter "name=$PROJECT_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
    
    echo ""
    echo -e "${BLUE}Services:${NC}"
    check_service_health
    
    echo ""
    echo -e "${BLUE}Resource Usage:${NC}"
    docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" $(docker ps -q --filter "name=$PROJECT_NAME" 2>/dev/null) 2>/dev/null || echo "No containers running"
}

check_service_health() {
    # Check web interface
    if curl -s --max-time 5 http://localhost:8000/health &> /dev/null; then
        print_success "Web Interface (8000): Accessible"
    else
        print_error "Web Interface (8000): Not accessible"
    fi
    
    # Check API
    if curl -s --max-time 5 http://localhost:5000/health &> /dev/null; then
        print_success "Robot API (5000): Accessible"
    else
        print_warning "Robot API (5000): Not accessible"
    fi
    
    # Check n8n (only if not in minimal mode)
    if [ "$MINIMAL_MODE" != true ]; then
        if curl -s --max-time 5 http://localhost:5678 &> /dev/null; then
            print_success "n8n Automation (5678): Accessible"
        else
            print_warning "n8n Automation (5678): Not running"
        fi
    fi
}

show_access_info() {
    echo ""
    print_header "Access Information"
    
    local ip=$(hostname -I | awk '{print $1}')
    
    echo -e "${GREEN}System Ready!${NC}"
    echo ""
    echo -e "${BLUE}Web Interfaces:${NC}"
    echo "  Web Dashboard:  http://localhost:8000"
    echo "  Remote Access:  http://${ip}:8000"
    echo ""
    echo -e "${BLUE}Additional Services:${NC}"
    if [ "$MINIMAL_MODE" = true ]; then
        echo "  Robot API:      http://localhost:5000"
        echo "  WebSocket:      ws://localhost:8765"
        echo "  n8n Automation: Not started (minimal mode)"
    else
        echo "  Robot API:      http://localhost:5000"
        echo "  n8n Automation: http://localhost:5678"
        echo "  WebSocket:      ws://localhost:8765"
    fi
    echo ""
    
    if [ "$MODE" = "hw" ] || [ "$MODE" = "hardware" ]; then
        echo -e "${GREEN}Hardware Mode:${NC}"
        echo "  • Real sensors connected"
        echo "  • MPU6050 IMU (I2C)"
        echo "  • Distance sensors (SPI/MCP3008)"
        echo "  • GPIO control active"
    else
        echo -e "${YELLOW}Simulation Mode:${NC}"
        echo "  • Simulated sensor data"
        echo "  • No hardware required"
        echo "  • Development/testing"
    fi
    
    echo ""
    print_info "Quick commands:"
    echo "  ./start --status    # Check status"
    echo "  ./start --logs      # View logs"
    echo "  ./start --test      # Run tests"
    echo "  ./start --stop      # Stop system"
}

show_logs() {
    print_header "Container Logs"
    
    local service="${1:-all}"
    
    if [ "$service" = "all" ]; then
        print_info "Showing all logs (Ctrl+C to exit)..."
        # Try all compose files
        for compose in docker-compose.yml docker-compose.dev.yml docker-compose.prod.yml; do
            if [ -f "$compose" ]; then
                docker compose -f "$compose" -p "$PROJECT_NAME" logs -f --tail=50 2>/dev/null && break
            fi
        done
    else
        print_info "Showing logs for $service (Ctrl+C to exit)..."
        docker logs -f "$service" 2>&1
    fi
}

#################################################################
# Test Mode
#################################################################

run_tests() {
    print_header "LKS Robot - Test Mode"
    
    print_info "Running system tests..."
    echo ""
    
    # Test 1: Container health
    print_info "[1/5] Checking containers..."
    if docker ps | grep -q "$PROJECT_NAME"; then
        print_success "Containers running"
    else
        print_error "No containers running - start with: ./start --hw or --sim"
        return 1
    fi
    
    # Test 2: API endpoints
    print_info "[2/5] Testing API endpoints..."
    
    # Test robot API
    if curl -s --max-time 5 http://localhost:5000/health > /dev/null 2>&1; then
        print_success "Robot API responding"
        
        # Get API status
        local api_status=$(curl -s --max-time 5 http://localhost:5000/api/status 2>/dev/null || echo "")
        if [ -n "$api_status" ]; then
            print_info "API Status: $api_status"
        fi
    else
        print_error "Robot API not responding"
    fi
    
    # Test web interface
    if curl -s --max-time 5 http://localhost:8000 > /dev/null 2>&1; then
        print_success "Web interface responding"
    else
        print_error "Web interface not responding"
    fi
    
    # Test 3: WebSocket
    print_info "[3/5] Testing WebSocket..."
    if timeout 5 bash -c 'echo > /dev/tcp/localhost/8765' 2>/dev/null; then
        print_success "WebSocket port accessible"
    else
        print_warning "WebSocket port not accessible"
    fi
    
    # Test 4: Sensor endpoints (if hardware mode)
    print_info "[4/5] Testing sensor endpoints..."
    local imu_test=$(curl -s --max-time 5 http://localhost:5000/api/sensors/imu 2>/dev/null || echo "")
    if [ -n "$imu_test" ]; then
        print_success "IMU endpoint responding"
        echo "  Data: $imu_test"
    else
        print_warning "IMU endpoint not responding"
    fi
    
    # Test 5: Movement commands
    print_info "[5/5] Testing movement API..."
    local move_test=$(curl -s --max-time 5 -X POST http://localhost:5000/api/move/stop 2>/dev/null || echo "")
    if [ -n "$move_test" ]; then
        print_success "Movement API responding"
    else
        print_warning "Movement API not responding"
    fi
    
    echo ""
    print_success "Test suite completed"
    echo ""
    
    # Interactive test menu
    interactive_test_menu
}

interactive_test_menu() {
    print_info "Interactive Test Menu"
    echo ""
    
    while true; do
        echo -e "${BLUE}Select a test:${NC}"
        echo "  1. Test movement (forward)"
        echo "  2. Test movement (turn left)"
        echo "  3. Test movement (turn right)"
        echo "  4. Test movement (stop)"
        echo "  5. Read all sensors"
        echo "  6. Test gripper"
        echo "  7. View ROS2 topics"
        echo "  8. View system status"
        echo "  9. Exit test mode"
        echo ""
        read -p "Enter choice (1-9): " choice
        
        case $choice in
            1)
                print_info "Testing forward movement..."
                curl -X POST -H "Content-Type: application/json" \
                    -d '{"linear": 0.2, "angular": 0}' \
                    http://localhost:5000/api/move 2>/dev/null
                print_success "Command sent"
                ;;
            2)
                print_info "Testing left turn..."
                curl -X POST -H "Content-Type: application/json" \
                    -d '{"linear": 0, "angular": 0.5}' \
                    http://localhost:5000/api/move 2>/dev/null
                print_success "Command sent"
                ;;
            3)
                print_info "Testing right turn..."
                curl -X POST -H "Content-Type: application/json" \
                    -d '{"linear": 0, "angular": -0.5}' \
                    http://localhost:5000/api/move 2>/dev/null
                print_success "Command sent"
                ;;
            4)
                print_info "Stopping robot..."
                curl -X POST http://localhost:5000/api/move/stop 2>/dev/null
                print_success "Robot stopped"
                ;;
            5)
                print_info "Reading sensors..."
                curl -s http://localhost:5000/api/sensors/all 2>/dev/null | python3 -m json.tool || echo "Failed to read sensors"
                ;;
            6)
                print_info "Testing gripper..."
                curl -X POST -H "Content-Type: application/json" \
                    -d '{"action": "open"}' \
                    http://localhost:5000/api/gripper 2>/dev/null
                sleep 1
                curl -X POST -H "Content-Type: application/json" \
                    -d '{"action": "close"}' \
                    http://localhost:5000/api/gripper 2>/dev/null
                print_success "Gripper test complete"
                ;;
            7)
                print_info "ROS2 topics:"
                # Find the running container
                local container=$(docker ps --filter "name=$PROJECT_NAME" --format "{{.Names}}" | head -1)
                if [ -n "$container" ]; then
                    docker exec "$container" bash -c "source /opt/ros/*/setup.bash && ros2 topic list" 2>/dev/null || echo "Failed to list topics"
                else
                    print_error "No running container found"
                fi
                ;;
            8)
                show_status
                ;;
            9)
                print_info "Exiting test mode"
                break
                ;;
            *)
                print_error "Invalid choice"
                ;;
        esac
        echo ""
    done
}

#################################################################
# ROS2 Direct Start (no Docker)
#################################################################

start_ros2_direct() {
    print_header "Starting ROS2 Direct (No Docker)"
    
    if [ ! -d "$ROS2_WS" ]; then
        print_error "ROS2 workspace not found: $ROS2_WS"
        return 1
    fi
    
    cd "$ROS2_WS"
    
    if [ ! -f "install/setup.bash" ]; then
        print_error "ROS2 workspace not built. Run: ./setup --pc"
        return 1
    fi
    
    print_info "Sourcing ROS2 workspace..."
    source install/setup.bash
    
    print_info "Starting web interface..."
    
    if [ "$MODE" = "hw" ] || [ "$MODE" = "hardware" ]; then
        python3 src/my_robot_automation/scripts/web_robot_interface.py --hardware
    else
        python3 src/my_robot_automation/scripts/web_robot_interface.py --simulation
    fi
}

#################################################################
# Utility Functions
#################################################################

enter_shell() {
    print_header "Entering Container Shell"
    
    local container=$(docker ps --filter "name=$PROJECT_NAME" --format "{{.Names}}" | head -1)
    
    if [ -z "$container" ]; then
        print_error "No running container found"
        return 1
    fi
    
    print_info "Entering: $container"
    docker exec -it "$container" /bin/bash
}

clean_system() {
    print_header "Clean System"
    
    print_warning "This will remove all containers, volumes, and images"
    read -p "Are you sure? (yes/no): " confirm
    
    if [ "$confirm" != "yes" ]; then
        print_info "Cleanup cancelled"
        return 0
    fi
    
    print_info "Stopping containers..."
    stop_containers
    
    print_info "Removing volumes..."
    docker volume prune -f
    
    print_info "Cleaning Docker system..."
    docker system prune -f
    
    print_success "System cleaned"
}

#################################################################
# Usage
#################################################################

show_usage() {
    cat << EOF
LKS Robot Project - Start Script

USAGE:
    ./start [MODE] [OPTIONS]

MODES:
    --hw, --hardware    Start in hardware mode (real sensors on Raspberry Pi)
    --sim, --simulation Start in simulation mode (simulated sensors)
    --test              Run system tests and interactive test menu

OPTIONS:
    --minimal           Start in minimal mode (Web UI + ROS2 only, no n8n)

OPERATIONS:
    --status            Show system status
    --logs [service]    Show logs (all or specific service)
    --stop              Stop all containers
    --restart           Restart all containers
    --shell             Enter container shell
    --clean             Clean Docker system

OPTIONS:
    --build             Force rebuild Docker images
    --foreground        Run in foreground (don't detach)
    --direct            Start ROS2 directly (no Docker)
    -h, --help          Show this help

EXAMPLES:
    ./start --hw                # Start with real hardware + n8n
    ./start --sim               # Start with simulation + n8n
    ./start --hw --minimal      # Start hardware mode (Web UI + ROS2 only)
    ./start --sim --minimal     # Start simulation mode (Web UI + ROS2 only)
    ./start --test              # Run tests
    ./start --hw --build        # Rebuild and start hardware mode
    ./start --status            # Check system status
    ./start --logs              # View all logs
    ./start --stop              # Stop system

ACCESS:
    Web Dashboard:  http://localhost:8000
    Robot API:      http://localhost:5000
    n8n:            http://localhost:5678

EOF
}

#################################################################
# Main
#################################################################

main() {
    # Parse arguments
    local operation=""
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --hw|--hardware)
                MODE="hw"
                shift
                ;;
            --sim|--simulation)
                MODE="sim"
                shift
                ;;
            --minimal)
                MINIMAL_MODE=true
                shift
                ;;
            --test)
                operation="test"
                shift
                ;;
            --status)
                operation="status"
                shift
                ;;
            --logs)
                operation="logs"
                shift
                ;;
            --stop)
                operation="stop"
                shift
                ;;
            --restart)
                operation="restart"
                shift
                ;;
            --shell)
                operation="shell"
                shift
                ;;
            --clean)
                operation="clean"
                shift
                ;;
            --build)
                BUILD_FLAG="--build"
                shift
                ;;
            --foreground)
                DETACH=false
                shift
                ;;
            --direct)
                operation="direct"
                shift
                ;;
            -h|--help)
                show_usage
                exit 0
                ;;
            *)
                print_error "Unknown option: $1"
                show_usage
                exit 1
                ;;
        esac
    done
    
    # Handle operations
    case "$operation" in
        status)
            show_status
            exit 0
            ;;
        logs)
            show_logs
            exit 0
            ;;
        stop)
            stop_containers
            exit 0
            ;;
        restart)
            if [ -z "$MODE" ]; then
                MODE="sim"  # Default to simulation
            fi
            restart_containers
            exit 0
            ;;
        shell)
            enter_shell
            exit 0
            ;;
        clean)
            clean_system
            exit 0
            ;;
        test)
            # Start in sim mode if not running
            if ! docker ps | grep -q "$PROJECT_NAME"; then
                print_info "Starting system for testing..."
                MODE="sim"
                start_containers
                sleep 5
            fi
            run_tests
            exit 0
            ;;
        direct)
            if [ -z "$MODE" ]; then
                MODE="sim"
            fi
            start_ros2_direct
            exit 0
            ;;
        "")
            # Default: start containers
            if [ -z "$MODE" ]; then
                print_error "No mode specified. Use --hw, --sim, or --test"
                show_usage
                exit 1
            fi
            ;;
    esac
    
    # Check prerequisites
    check_prerequisites || exit 1
    
    # Start containers
    start_containers
}

main "$@"

